#!/usr/bin/env python

import subprocess, os, time, sys

server_env = dict(os.environ)
server_env['LD_PRELOAD'] = os.path.join(os.getcwd(), 'interpose.so')
server = subprocess.Popen('server/install/sbin/libvirtd', env=server_env, stderr=open(os.devnull))
time.sleep(5)
if server.poll():
	raise AssertionError
#test_env = dict(os.environ)
#test_env['LD_LIBRARY_PATH'] = os.path.join(os.getcwd(), 'server/install/lib')
test = subprocess.call('./microbench.sh')
subprocess.call(['pkill', '-9', '-u', 'tag', 'libvirtd'])

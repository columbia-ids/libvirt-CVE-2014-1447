#!/usr/bin/env python

import subprocess, sys, time, os

subprocess.call(['pkill', 'libvirtd'])
count=0
server_env = dict(os.environ)
server_env['LD_PRELOAD'] = os.path.join(os.getcwd(), 'interpose.so')
time.sleep(3)
server = subprocess.Popen('server/install/sbin/libvirtd', env=server_env, stderr=open(os.devnull))
while(True):
	if server.poll():
		print str(count) + ' runs until failure.'
		sys.exit()
	subprocess.Popen('./bug.sh', stderr=open(os.devnull))
	count += 1
server.terminate()
print 'No failure.'

#!/usr/bin/env python

import subprocess, sys, time

count=0
subprocess.call(['pkill', 'libvirtd'])
time.sleep(3)
server = subprocess.Popen(['LD_PRELOAD=$(pwd)/interpose.so', 'server/install/sbin/libvirtd'])
while(True):
	if server.poll():
		print str(count) + ' runs until failure.'
		sys.exit()
	subprocess.Popen('./bug.sh', stdin=None, stdout=None, stderr=None, close_fds=True)
	count += 1
server.terminate()
print 'No failure.'

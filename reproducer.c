#include <stdio.h>
#include <pthread.h>
#include <libvirt/libvirt.h>

#define NUMCPUS 2

void *openclose(void *name)
{
	virConnectPtr thisCP;
	//thisCP = virConnectOpen((const char *)name);
	//thisCP = virConnectOpen(NULL);
	thisCP = virConnectOpen("qemu:///session");
	virConnectClose(thisCP);
}

int main()
{
	int i, counter;
	pthread_t thread_array[NUMCPUS];
	char *name[2] = {NULL, "qemu:///session"};

	counter = 0;
	for(i=0; i<NUMCPUS; i++)
	{
		sprintf(name, "qemu:///%d", counter);
		pthread_create(&thread_array[i], NULL, &openclose, (void *)name);
		counter++;
	}

	while(1)
	{
		for(i=0; i<NUMCPUS; i++)
		{
			sprintf(name, "qemu:///%d", counter);
			pthread_join(thread_array[i], NULL);
			pthread_create(&thread_array[i], NULL, &openclose, (void *) name);
			counter++;
		}
	}
}

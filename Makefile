libvirt_version = 0.9.8
build_dir = libvirt-$(libvirt_version)
install_dir = $(HOME)/libvirt

build : $(install_dir)/sbin/libvirtd

$(install_dir)/sbin/libvirtd : $(build_dir)/Makefile
	cd $(build_dir); CFLAGS="-g -O0"; \
		./configure --without-udev --prefix=$(install_dir)
	make -C $(build_dir)
	make -C $(build_dir) install

$(build_dir)/Makefile : libvirt-$(libvirt_version).tar.gz
	tar xvf libvirt-$(libvirt_version).tar.gz

interpose.so : interpose.c
	CPATH=$(build_dir)/include:$(build_dir)/src/util:$(build_dir)/src/rpc:$(build_dir)/src:$(build_dir)/gnulib/lib:$(build_dir)/src/conf:/usr/include/libxml2 \
		gcc -shared -ldl -fPIC -fno-builtin interpose.c -o interpose.so

.PHONY : build libvirtd clean

random :
	./gen_interpose.py $(MAX_DELAY)
	make interpose.so

libvirtd : build
	$(install_dir)/sbin/libvirtd &

clean :
	rm -vrf $(build_dir) $(install_dir)

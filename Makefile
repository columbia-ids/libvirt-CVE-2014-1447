libvirt_version = 0.9.8
server_dir = $(PWD)/server
client_dir = $(PWD)/client
server_src_dir = $(server_dir)/libvirt-$(libvirt_version)
client_src_dir = $(client_dir)/libvirt-$(libvirt_version)
server_build_dir = $(server_dir)/build
client_build_dir = $(client_dir)/build
server_install_dir = $(server_dir)/install
client_install_dir = $(client_dir)/install

build : $(server_install_dir)/lib/libvirt.so $(client_install_dir)/lib/libvirt.so perftest

$(server_install_dir)/lib/libvirt.so : $(server_src_dir)/configure
	-mkdir -v $(server_build_dir)
	cd $(server_build_dir);	$(server_src_dir)/configure --without-udev --prefix=$(server_install_dir)
	make -j$(NUMCPUS) -C $(server_build_dir)
	make -j$(NUMCPUS) -C $(server_build_dir) install

$(server_src_dir)/configure : downloads/libvirt-$(libvirt_version).tar.gz patches/stdio.patch patches/virnetdevbridge.patch patches/configure.patch
	make clean-server
	mkdir -v $(server_dir)
	tar xvf downloads/libvirt-$(libvirt_version).tar.gz -C $(server_dir)
	patch -d $(server_src_dir) -p0 < patches/stdio.patch
	patch -d $(server_src_dir) -p0 < patches/virnetdevbridge.patch
	patch -d $(server_src_dir) -p0 < patches/configure.patch
	cd $(server_src_dir); autoconf

$(client_install_dir)/lib/libvirt.so : $(client_src_dir)/configure
	-mkdir -v $(client_build_dir)
	cd $(client_build_dir); $(client_src_dir)/configure --without-udev --prefix=$(client_install_dir)
	make -j$(NUMCPUS) -C $(client_build_dir)
	make -j$(NUMCPUS) -C $(client_build_dir) install

$(client_src_dir)/configure : downloads/libvirt-$(libvirt_version).tar.gz patches/reproducer.patch patches/stdio.patch patches/virnetdevbridge.patch patches/configure.patch
	make clean-client
	mkdir -v $(client_dir)
	tar xvf downloads/libvirt-$(libvirt_version).tar.gz -C $(client_dir)
	patch -d $(client_src_dir) -p0 < patches/reproducer.patch
	patch -d $(client_src_dir) -p0 < patches/stdio.patch
	patch -d $(client_src_dir) -p0 < patches/virnetdevbridge.patch
	patch -d $(client_src_dir) -p0 < patches/configure.patch
	cd $(client_src_dir); autoconf

downloads/libvirt-$(libvirt_version).tar.gz :
	-mkdir -v downloads
	wget -vP downloads http://libvirt.org/sources/libvirt-$(libvirt_version).tar.gz \
	|| wget -vP downloads http://libvirt.org/sources/old/libvirt-$(libvirt_version).tar.gz

perftest : perftest.c $(server_install_dir)/lib/libvirt.so
	gcc -o perftest perftest.c -I$(server_install_dir)/include -L$(server_install_dir)/lib -lvirt

interpose.so : interpose.c
	gcc -shared -I$(server_install_dir)/include -ldl -L$(server_install_dir)/lib -lvirt -fPIC -fno-builtin -o interpose.so interpose.c

.PHONY : build random test-perf clean clean-server clean-client cleanlibs

random :
	tools/gen_interpose.py $(MAX_DELAY)
	make interpose.so

clean : clean-server clean-client
	rm -vrf perftest interpose.c interpose.so *.pyc

clean-server :
	rm -vrf $(server_dir)

clean-client :
	rm -vrf $(client_dir)

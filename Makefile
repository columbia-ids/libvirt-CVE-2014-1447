libvirt_version = 0.9.8
src_dir = $(PWD)/libvirt-$(libvirt_version)
server_build_dir = $(PWD)/libvirt-build-server
client_build_dir = $(PWD)/libvirt-build-client
server_dir = $(PWD)/libvirt-server
client_dir = $(PWD)/libvirt-client

build : $(server_dir)/lib/libvirt.so $(client_dir)/lib/libvirt.so reproducer

$(server_dir)/lib/libvirt.so : $(server_build_dir)/Makefile
	-mkdir -v $(server_build_dir)
	cd $(server_build_dir); CFLAGS="-g -O0"; \
		$(src_dir)/configure --without-udev --prefix=$(server_dir)
	make -j$(NUMCPUS) -C $(server_build_dir)
	make -C $(server_build_dir) install

$(server_build_dir)/Makefile : libvirt-$(libvirt_version).tar.gz sleep.patch
	rm -rf $(src_dir)
	tar xvf libvirt-$(libvirt_version).tar.gz
	#patch -d $(build_dir) -p0 < sleep.patch

$(client_dir)/lib/libvirt.so : $(client_build_dir)/Makefile
	-mkdir -v $(client_build_dir)
	cd $(client_build_dir); CFLAGS="-g -O0"; \
		$(src_dir)/configure --without-udev --prefix=$(client_dir)
	make -j$(NUMCPUS) -C $(client_build_dir)
	make -C $(client_build_dir) install

$(client_build_dir)/Makefile : libvirt-$(libvirt_version).tar.gz reproducer.patch $(server_dir)/lib/libvirt.so
	rm -rf $(src_dir)
	tar xvf libvirt-$(libvirt_version).tar.gz
	patch -d $(src_dir) -p0 < reproducer.patch

reproducer : reproducer.c $(client_dir)/lib/libvirt.so
	gcc -o reproducer reproducer.c -I$(client_dir)/include -L$(client_dir)/lib -lpthread -lvirt

interpose.so : interpose.c
	CPATH=$(server_build_dir)/include:$(server_build_dir)/src/util:$(server_build_dir)/src/rpc:$(server_build_dir)/src:$(server_build_dir)/gnulib/lib:$(server_build_dir)/src/conf:/usr/include/libxml2 \
		gcc -shared -ldl -fPIC -fno-builtin interpose.c -o interpose.so

.PHONY : build random run clean

random :
	./gen_interpose.py $(MAX_DELAY)
	make interpose.so

run : build
	LD_LIBRARY_PATH=$(client_dir)/lib ./reproducer

clean :
	rm -vrf $(server_build_dir) $(client_build_dir) $(server_dir) $(client_dir) $(extract_dir)
